name: CD Pipeline

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Manual deployment environment'
        type: environment
        required: true

jobs:
  deploy-backend:
    name: Deploy Backend
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_SERVER_API_TOKEN }}
    environment:
      name: staging
      url: https://wdcc-uabc-backend-staging.fly.dev/
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Backend Secrets
        id: backend-secrets
        run: flyctl secrets set --config fly.staging.backend.toml DATABASE_URI=${{ secrets.DATABASE_URI }} JWT_SECRET=${{ secrets.JWT_SECRET }} PAYLOAD_SECRET=${{ secrets.PAYLOAD_SECRET }} GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} NEXT_PUBLIC_URL=${{ secrets.NEXT_PUBLIC_URL }} TURBO_TEAM=${{ vars.TURBO_TEAM }} TURBO_TOKEN=${{ secrets.TURBO_TOKEN }} NEXT_PUBLIC_URL=${{ secrets.NEXT_PUBLIC_URL }} NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Deploy Backend Secrets
        id: backend-secrets-deploy
        run: flyctl secrets deploy --config fly.staging.backend.toml

      - name: Deploy Backend
        id: deploy-backend
        run: >
          flyctl deploy --remote-only --config fly.staging.backend.toml
          --build-secret DATABASE_URI="${{ secrets.DATABASE_URI }}"
          --build-secret JWT_SECRET="${{ secrets.JWT_SECRET }}"
          --build-secret PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
          --build-secret GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
          --build-secret GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
          --build-secret NEXT_PUBLIC_URL="${{ secrets.NEXT_PUBLIC_URL }}"
          --build-secret TURBO_TEAM="${{ vars.TURBO_TEAM }}"
          --build-secret TURBO_TOKEN="${{ secrets.TURBO_TOKEN }}"
          --build-secret NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}"

  deploy-frontend:
    name: Deploy Frontend
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_CLIENT_API_TOKEN }}
    environment:
      name: staging
      url: https://wdcc-uabc-frontend-staging.fly.dev/
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Frontend Secrets
        id: frontend-secrets
        run: flyctl secrets set --config fly.staging.frontend.toml NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} NEXT_PUBLIC_URL=${{ secrets.NEXT_PUBLIC_URL }} JWT_SECRET=${{ secrets.JWT_SECRET }} TURBO_TEAM=${{ vars.TURBO_TEAM }} TURBO_TOKEN=${{ secrets.TURBO_TOKEN }}

      - name: Deploy Frontend Secrets
        id: frontend-secrets-deploy
        run: flyctl secrets deploy --config fly.staging.frontend.toml

      - name: Deploy Frontend
        id: deploy-frontend
        run: >
          flyctl deploy --remote-only --config fly.staging.frontend.toml
          --build-secret NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}"
          --build-secret NEXT_PUBLIC_URL="${{ secrets.NEXT_PUBLIC_URL }}"
          --build-secret JWT_SECRET="${{ secrets.JWT_SECRET }}"
          --build-secret TURBO_TEAM="${{ vars.TURBO_TEAM }}"
          --build-secret TURBO_TOKEN="${{ secrets.TURBO_TOKEN }}"

  deploy-to-production:
    name: Deploy UABC Production App
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_APP_API_TOKEN }}
    environment:
      name: production
      url: https://uabc.wdcc.co.nz/
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: echo "To be implemented"
