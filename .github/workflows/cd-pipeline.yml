name: CD Pipeline

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Manual deployment environment'
        type: environment
        required: true

jobs:
  deploy-to-staging-backend:
    name: Deploy UABC Backend Staging App
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_APP_API_TOKEN }}
    environment:
      name: backend-staging
      url: https://wdcc-uabc-backend-staging.fly.dev/
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Set Fly.io secrets
        run: flyctl secrets set --config fly.staging.backend.toml DATABASE_URI=${{ secrets.DATABASE_URI }} PAYLOAD_SECRET=${{ secrets.PAYLOAD_SECRET }} GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} NEXT_PUBLIC_URL=${{ secrets.NEXT_PUBLIC_URL }} NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} TURBO_TEAM=${{ vars.TURBO_TEAM }} TURBO_TOKEN=${{ secrets.TURBO_TOKEN }}
      - name: Deploy secrets to Fly.io
        run: flyctl secrets deploy --config fly.staging.backend.toml
      - name: Deploy application to Fly.io
        run: flyctl deploy --remote-only --config fly.staging.backend.toml

  deploy-to-staging-frontend:
    name: Deploy UABC Frontend Staging App
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_APP_API_TOKEN }}
    environment:
      name: frontend-staging
      url: https://wdcc-uabc-frontend-staging.fly.dev/
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Set Fly.io secrets
        run: flyctl secrets set --config fly.staging.frontend.toml NEXT_PUBLIC_URL=${{ secrets.NEXT_PUBLIC_URL }} NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} TURBO_TEAM=${{ vars.TURBO_TEAM }} TURBO_TOKEN=${{ secrets.TURBO_TOKEN }}
      - name: Deploy secrets to Fly.io
        run: flyctl secrets deploy --config fly.staging.frontend.toml
      - name: Deploy application to Fly.io
        run: flyctl deploy --remote-only --config fly.staging.frontend.toml

  deploy-to-production:
    name: Deploy UABC Production App
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_APP_API_TOKEN }}
    environment:
      name: production
      url: https://uabc.wdcc.co.nz/
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: echo "To be implemented"